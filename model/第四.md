Sub ConvertLaTeXToEquation()
    Dim rng As Range
    Dim txt As String
    Dim startPos As Long
    Dim endPos As Long
    
    Set rng = ActiveDocument.Content
    txt = rng.Text
    
    ' 从后往前找，避免位置偏移
    endPos = InStrRev(txt, "$")
    
    Do While endPos > 0
        startPos = InStrRev(txt, "$", endPos - 1)
        
        If startPos > 0 And startPos < endPos Then
            Dim latexCode As String
            latexCode = Mid(txt, startPos + 1, endPos - startPos - 1)
            
            ' 跳过空内容
            If Len(Trim(latexCode)) > 0 Then
                ' 选中$...$区域
                ActiveDocument.Range(startPos - 1, endPos).Select
                
                ' 删除选中内容
                Selection.Delete
                
                ' 插入Word公式
                Dim eq As OMath
                Selection.InsertBefore latexCode
                ActiveDocument.Range(Selection.Start, Selection.Start + Len(latexCode)).Select
                
                ' 转换为公式
                Selection.OMaths.Add Selection.Range
                Selection.OMaths(1).BuildUp
            End If
            
            ' 更新文本和位置
            txt = ActiveDocument.Content.Text
            endPos = InStrRev(txt, "$", startPos - 1)
        Else
            Exit Do
        End If
    Loop
    
    MsgBox "转换完成！"
End Sub
