# check_all_labels.py
import os
import numpy as np
from PIL import Image
from collections import Counter

def check_all_dataset_labels():
    """检查整个数据集的所有标签"""
    
    # 路径设置
    train_label_dir = 'dataset/train/lbl'
    val_label_dir = 'dataset/val/lbl'
    test_label_dir = 'dataset/test/lbl'  # 如果有的话
    
    all_labels = Counter()
    file_count = 0
    
    # 检查所有数据集
    for dataset_name, label_dir in [('训练集', train_label_dir), 
                                    ('验证集', val_label_dir)]:
        if os.path.exists(label_dir):
            print(f"\n检查{dataset_name}: {label_dir}")
            dataset_labels = Counter()
            
            for filename in os.listdir(label_dir):
                if filename.endswith(('.png', '.tif', '.jpg')):
                    label_path = os.path.join(label_dir, filename)
                    label = Image.open(label_path).convert('L')
                    label_array = np.array(label)
                    
                    # 统计标签
                    unique, counts = np.unique(label_array, return_counts=True)
                    for val, count in zip(unique, counts):
                        dataset_labels[val] += count
                        all_labels[val] += count
                    
                    file_count += 1
            
            print(f"  文件数: {file_count}")
            print(f"  标签分布:")
            for label_val in sorted(dataset_labels.keys()):
                print(f"    标签 {label_val}: {dataset_labels[label_val]} 像素")
    
    print(f"\n===== 总结 =====")
    print(f"所有标签值: {sorted(all_labels.keys())}")
    print(f"标签数量: {len(all_labels)}")
    print(f"\n完整标签分布:")
    for label_val in sorted(all_labels.keys()):
        print(f"  标签 {label_val}: {all_labels[label_val]} 像素")
    
    # 检查是否符合7类
    if len(all_labels) == 6:
        print("\n⚠️ 只发现6个标签值，可能需要加上背景类(0)作为第7类")
    elif len(all_labels) == 7:
        print("\n✓ 发现7个标签值，与文档一致")
    else:
        print(f"\n❌ 发现{len(all_labels)}个标签值，与文档不符")

if __name__ == "__main__":
    check_all_dataset_labels()
